<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Wer bin ich?</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 20px;
      min-height: 100vh;
      background: #f2f4f8;
    }

    .app {
      background: rgba(255, 255, 255, 0.85);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 18px rgba(0, 0, 0, 0.2);
    }

    input, button, select { margin: 5px 0; padding: 5px; width: 100%; }
    .hidden { display: none; }

    #playerList {
      list-style: none;
      padding: 0;
      margin: 10px 0;
    }

    #playerList li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 6px;
    }

    #playerList button {
      width: auto;
      padding: 4px 8px;
      margin: 0;
    }
  </style>
</head>
<body>

<div class="app">
<h1>Wer bin ich?</h1>

<!-- Spieler anmelden -->
<div id="registerDiv" class="hidden">
  <h2>Spieler anmelden</h2>
  <input type="text" id="playerName" placeholder="Dein Name">
  <button onclick="registerPlayer()">Anmelden</button>
  <p id="registerMsg"></p>

  <h3>Aktuell angemeldet</h3>
  <ul id="playerList"></ul>
  <button id="beginAssignBtn" class="hidden" onclick="beginAssignment()">Runde starten</button>
</div>

<!-- Runde starten -->
<div id="startDiv">
  <h2>Spiel starten</h2>
  <button onclick="startRound()">Spiel starten</button>
</div>

<!-- Figur zuweisen -->
<div id="assignDiv" class="hidden">
  <h2>Figur zuweisen</h2>
  <p id="assignedText"></p>
  <input type="text" id="characterInput" placeholder="Figur eingeben">
  <button onclick="submitCharacter()">Absenden</button>
</div>

<!-- Ergebnisse -->
<div id="resultDiv" class="hidden">
  <h2>Ergebnisse</h2>
  <div id="results"></div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, setDoc, doc, updateDoc, deleteDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCuiS6zrw_zjRGVpM70nOMSiJezmm9EOeE",
  authDomain: "wer-bin-ich-a160b.firebaseapp.com",
  projectId: "wer-bin-ich-a160b",
  storageBucket: "wer-bin-ich-a160b.firebasestorage.app",
  messagingSenderId: "40347667202",
  appId: "1:40347667202:web:69d18b15506b7f2510501b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentPlayer = localStorage.getItem("werBinIchName") || "";
let assignedPlayer = "";

const clientId = localStorage.getItem("werBinIchClientId") || crypto.randomUUID();
localStorage.setItem("werBinIchClientId", clientId);
const roundRef = doc(db, "meta", "round");

function showScreen(screen) {
  document.getElementById("registerDiv").classList.toggle("hidden", screen !== "register");
  document.getElementById("startDiv").classList.toggle("hidden", screen !== "start");
  document.getElementById("assignDiv").classList.toggle("hidden", screen !== "assign");
  document.getElementById("resultDiv").classList.toggle("hidden", screen !== "result");
}

function isHost(roundData) {
  return roundData && roundData.hostId === clientId;
}

async function registerPlayer() {
  const name = document.getElementById("playerName").value.trim();
  if (!name) return alert("Bitte Name eingeben!");

  currentPlayer = name;
  localStorage.setItem("werBinIchName", name);

  await setDoc(doc(db, "players", name), { name, assignedTo: "", character: "", ownerId: clientId });
  document.getElementById("registerMsg").innerText = `Du bist angemeldet als ${name}`;
  document.getElementById("playerName").value = "";
  await renderPlayers();
}

async function startRound() {
  await setDoc(roundRef, { phase: "register", hostId: clientId, startedAt: Date.now() });
  showScreen("register");
  await renderPlayers();
  alert("Anmelden ist jetzt für alle sichtbar. Als Starter kannst du Namen entfernen und dann auf 'Runde starten' klicken.");
}

function assignDerangement(players) {
  let shuffled = [...players];
  let valid = false;

  while (!valid) {
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }

    valid = true;
    for (let i = 0; i < players.length; i++) {
      if (players[i] === shuffled[i]) {
        valid = false;
        break;
      }
    }
  }

  const assignments = {};
  for (let i = 0; i < players.length; i++) {
    assignments[players[i]] = shuffled[i];
  }
  return assignments;
}

async function assignPlayers() {
  const snapshot = await getDocs(collection(db, "players"));
  const players = snapshot.docs.map(d => d.data().name);

  if (players.length < 2) {
    alert("Mindestens 2 Spieler benötigt.");
    return false;
  }

  const assignments = assignDerangement(players);
  for (const giver of players) {
    await updateDoc(doc(db, "players", giver), { assignedTo: assignments[giver] });
  }

  await loadAssignedPlayer();
  return true;
}

async function beginAssignment() {
  const roundSnap = await getDoc(roundRef);
  const roundData = roundSnap.exists() ? roundSnap.data() : null;

  if (!isHost(roundData)) {
    alert("Nur der Starter kann die Runde starten.");
    return;
  }

  const ok = await assignPlayers();
  if (!ok) return;

  await updateDoc(roundRef, { phase: "assign" });
}

async function loadAssignedPlayer() {
  const meSnap = await getDoc(doc(db, "players", currentPlayer));
  if (!meSnap.exists()) return;

  assignedPlayer = meSnap.data().assignedTo;
  if (!assignedPlayer) return;

  document.getElementById("assignedText").innerText = `Du weist ${assignedPlayer} eine Figur zu`;
}

async function submitCharacter() {
  const character = document.getElementById("characterInput").value.trim();
  if (!character) return alert("Bitte Figur eingeben!");

  await updateDoc(doc(db, "players", assignedPlayer), { character });
  alert(`Figur für ${assignedPlayer} gespeichert!`);
  document.getElementById("characterInput").value = "";

  showScreen("result");
  await showResult();
}

async function renderPlayers() {
  const roundSnap = await getDoc(roundRef);
  const roundData = roundSnap.exists() ? roundSnap.data() : null;

  const snapshot = await getDocs(collection(db, "players"));
  const list = document.getElementById("playerList");
  list.innerHTML = "";

  snapshot.docs.forEach(d => {
    const data = d.data();
    const li = document.createElement("li");
    const text = document.createElement("span");
    text.textContent = data.name;
    li.appendChild(text);

    if (isHost(roundData)) {
      const removeBtn = document.createElement("button");
      removeBtn.textContent = "Entfernen";
      removeBtn.onclick = () => removePlayer(data.name);
      li.appendChild(removeBtn);
    }

    list.appendChild(li);
  });

  document.getElementById("beginAssignBtn").classList.toggle("hidden", !isHost(roundData));
}

async function removePlayer(name) {
  const roundSnap = await getDoc(roundRef);
  const roundData = roundSnap.exists() ? roundSnap.data() : null;

  if (!isHost(roundData)) {
    alert("Nur der Starter kann Spieler entfernen.");
    return;
  }

  await deleteDoc(doc(db, "players", name));
  await renderPlayers();
}

async function showResult() {
  if (!currentPlayer) {
    document.getElementById("results").innerHTML = "<p>Bitte zuerst anmelden.</p>";
    return;
  }

  const snapshot = await getDocs(collection(db, "players"));
  let html = "";
  snapshot.docs.forEach(d => {
    const data = d.data();
    html += `<p>${data.name}: ${data.name === currentPlayer ? "???" : (data.character || "—")}</p>`;
  });
  document.getElementById("results").innerHTML = html;
}

function subscribeRound() {
  onSnapshot(roundRef, async (snap) => {
    if (!snap.exists()) {
      showScreen("start");
      return;
    }

    const roundData = snap.data();

    if (roundData.phase === "register") {
      showScreen("register");
      await renderPlayers();
      return;
    }

    if (roundData.phase === "assign") {
      if (!currentPlayer) {
        showScreen("register");
        await renderPlayers();
        return;
      }

      const meSnap = await getDoc(doc(db, "players", currentPlayer));
      if (!meSnap.exists()) {
        showScreen("register");
        await renderPlayers();
        return;
      }

      const me = meSnap.data();
      if (me.character) {
        showScreen("result");
        await showResult();
      } else {
        showScreen("assign");
        await loadAssignedPlayer();
      }
    }
  });
}

window.registerPlayer = registerPlayer;
window.startRound = startRound;
window.beginAssignment = beginAssignment;
window.submitCharacter = submitCharacter;
window.removePlayer = removePlayer;

if (currentPlayer) {
  document.getElementById("registerMsg").innerText = `Du bist angemeldet als ${currentPlayer}`;
}

subscribeRound();
</script>

</body>
</html>
