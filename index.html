<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Wer bin ich?</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 20px; }
    input, button, select { margin: 5px 0; padding: 5px; width: 100%; }
    .hidden { display: none; }
    <img src="https://media.tenor.com/d9-oc__al-QAAAAM/subway-surfers.gif">
  </style>
</head>
<body>

<h1>Wer bin ich?</h1>

<!-- Spieler anmelden -->
<div id="registerDiv" class="hidden">
  <h2>Spieler anmelden</h2>
  <input type="text" id="playerName" placeholder="Dein Name">
  <button onclick="registerPlayer()">Anmelden</button>
  <p id="registerMsg"></p>
</div>

<!-- Runde starten -->
<div id="startDiv">
  <h2>Runde starten</h2>
  <button onclick="startRound()">Neue Runde starten</button>
</div>

<!-- Figur zuweisen -->
<div id="assignDiv" class="hidden">
  <h2>Figur zuweisen</h2>
  <p id="assignedText"></p>
  <input type="text" id="characterInput" placeholder="Figur eingeben">
  <button onclick="submitCharacter()">Absenden</button>
</div>

<!-- Ergebnisse -->
<div id="resultDiv" class="hidden">
  <h2>Ergebnisse</h2>
  <select id="resultSelect" onchange="showResult()">
    <option value="">Dein Name wÃ¤hlen</option>
  </select>
  <div id="results"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, setDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// ðŸ”¹ Firebase Config
const firebaseConfig = {
  apiKey: api_key,
  authDomain: "wer-bin-ich-a160b.firebaseapp.com",
  projectId: "wer-bin-ich-a160b",
  storageBucket: "wer-bin-ich-a160b.firebasestorage.app",
  messagingSenderId: "40347667202",
  appId: "1:40347667202:web:69d18b15506b7f2510501b"
};

// Firebase initialisieren
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentPlayer = "";
let assignedPlayer = "";

// ðŸ”¹ Alte Runde lÃ¶schen
async function resetRound() {
  const snapshot = await getDocs(collection(db, "players"));
  for (const d of snapshot.docs) {
    await deleteDoc(doc(db, "players", d.id));
  }
  console.log("Alte Runde gelÃ¶scht!");
}

// ðŸ”¹ Spieler anmelden
async function registerPlayer() {
  const name = document.getElementById("playerName").value.trim();
  if (!name) return alert("Bitte Name eingeben!");
  currentPlayer = name;

  await setDoc(doc(db, "players", name), { name: name, assignedTo: "", character: "" });
  document.getElementById("registerMsg").innerText = `Du bist angemeldet als ${name}`;
  document.getElementById("playerName").value = "";

  loadResultSelect();

  // Sobald mindestens 2 Spieler angemeldet sind â†’ Zuordnung freischalten
  const snapshot = await getDocs(collection(db, "players"));
  if (snapshot.docs.length >= 2) {
    document.getElementById("assignDiv").classList.remove("hidden");
    await assignPlayers();
  }
}

// ðŸ”¹ Runde starten
async function startRound() {
  await resetRound(); // alte Spieler lÃ¶schen

  // Sichtbarkeit
  document.getElementById("registerDiv").classList.remove("hidden");
  document.getElementById("startDiv").classList.add("hidden");
  document.getElementById("assignDiv").classList.add("hidden");
  document.getElementById("resultDiv").classList.add("hidden");

  alert("Alte Runde gelÃ¶scht! Jetzt kÃ¶nnen sich neue Spieler anmelden.");
}

// ðŸ”¹ ZufÃ¤llige Zuordnung (Derangement)
function assignDerangement(players) {
  let shuffled = [...players];
  let valid = false;

  while (!valid) {
    // Array mischen
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }

    // PrÃ¼fen, ob jemand sich selbst zugewiesen hat
    valid = true;
    for (let i = 0; i < players.length; i++) {
      if (players[i] === shuffled[i]) {
        valid = false;
        break;
      }
    }
  }

  // Zuordnung als Objekt zurÃ¼ckgeben
  const assignments = {};
  for (let i = 0; i < players.length; i++) {
    assignments[players[i]] = shuffled[i];
  }
  return assignments;
}

// ðŸ”¹ Spieler zuweisen
async function assignPlayers() {
  const snapshot = await getDocs(collection(db, "players"));
  const players = snapshot.docs.map(doc => doc.data().name);

  const assignments = assignDerangement(players);

  for (const giver of players) {
    await updateDoc(doc(db, "players", giver), { assignedTo: assignments[giver] });
  }

  loadAssignedPlayer();
}

// ðŸ”¹ Zeige welchem Spieler man die Figur zuweist
async function loadAssignedPlayer() {
  const snapshot = await getDocs(collection(db, "players"));
  const me = snapshot.docs.map(d => d.data()).find(p => p.name === currentPlayer);
  if (!me) return;
  assignedPlayer = me.assignedTo;
  document.getElementById("assignedText").innerText = `Du weist ${assignedPlayer} eine Figur zu`;
}

// ðŸ”¹ Figur absenden
async function submitCharacter() {
  const character = document.getElementById("characterInput").value.trim();
  if (!character) return alert("Bitte Figur eingeben!");
  await updateDoc(doc(db, "players", assignedPlayer), { character: character });
  alert(`Figur fÃ¼r ${assignedPlayer} gespeichert!`);
  document.getElementById("characterInput").value = "";
  document.getElementById("assignDiv").classList.add("hidden");
  document.getElementById("resultDiv").classList.remove("hidden");
  loadResultSelect();
}

// ðŸ”¹ Ergebnisse anzeigen
async function loadResultSelect() {
  const snapshot = await getDocs(collection(db, "players"));
  const select = document.getElementById("resultSelect");
  select.innerHTML = `<option value="">Dein Name wÃ¤hlen</option>`;
  snapshot.docs.forEach(doc => {
    const opt = document.createElement("option");
    opt.value = doc.data().name;
    opt.textContent = doc.data().name;
    select.appendChild(opt);
  });
}

async function showResult() {
  const player = document.getElementById("resultSelect").value;
  if (!player) return;
  const snapshot = await getDocs(collection(db, "players"));
  let html = "";
  snapshot.docs.forEach(doc => {
    const data = doc.data();
    html += `<p>${data.name}: ${data.name === player ? '???' : data.character}</p>`;
  });
  document.getElementById("results").innerHTML = html;
}

window.registerPlayer = registerPlayer;
window.startRound = startRound;
window.submitCharacter = submitCharacter;
window.showResult = showResult;

</script>

</body>
</html>
